params {
    input_dir = "/fasta_files"
    sample_names = ["sample1", "sample2", "sample3", "sample4", "sample5", "sample6"]
    replicate_info = ["1", "1", "1", "2", "2", "2"]
}

input_files = fileTree(dir: params.input_dir, include: "*.fastq.gz")

process read_map {
    input:
    file input from input_files

    output:
    file("${params.input_dir}/${input.baseName}_salmon")

    """
    salmon quant -i /index -p 20 --validateMappings --writeUnmappedNames -l A -r ${input} -o ${output}
    """
}

process trim {
    input:
    file salmon_output_file from fileTree(params.input_dir, include: "*_salmon/quant.sf")
    
    output:
    file("${params.input_dir}/${salmon_output_file.baseName}_trimmed")

    """
    trim_galore -q 20 --length 50 --fastqc --illumina --stringency 3 ${salmon_output_file} -o ${output}
    """
}

process generate_reads {
    input:
    file trimmed_file from fileTree(params.input_dir, include: "*_trimmed")

    output:
    file("${params.input_dir}/${trimmed_file.baseName}_reads.csv")

    """
    Rscript generate_reads.R ${trimmed_file} ${output} ${params.sample_names} ${params.replicate_info}
    """
}

process diff_exp {
    input:
    file reads_file from fileTree(params.input_dir, include: "*_reads.csv")

    output:
    file("${params.input_dir}/${reads_file.baseName}_diff_exp.csv")

    """
    Rscript diff_exp.R ${reads_file} ${output} ${params.sample_names} ${params.replicate_info}
    """
}

process go_kegg {
    input:
    file diff_exp_file from fileTree(params.input_dir, include: "*_diff_exp.csv")

    output:
    file("${params.input_dir}/${diff_exp_file.baseName}_go_kegg.csv")

    """
    Rscript go_kegg.R ${diff_exp_file} ${output}
    """
}

workflow {
    read_map
    trim
    generate_reads
    diff_exp
    go_kegg
}
